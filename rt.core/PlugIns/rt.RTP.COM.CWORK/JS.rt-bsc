function IsEqualArrays(a1,a2){if(!a1||!a2||a1.length!=a2.length){return false;}for(var i=0;i<a1.length;i++){if(a1[i]!=a2[i]){return false;}}return true;}function _xCWORK(id,URI,GRP,max,pre,idx,pld){var I=this;I.CLS="¬¬#SID#¬¬";I.id="¬¬#XID#¬¬";I.id=id;I.URI=URI;I.GRP=GRP;I.max=max;I.pre=pre;I.idx=idx;I.pld=pld;I.cmd=function(m,c,fn){try{c='XRT-SCRIPT?'+m+'&'+I.CLS+'&'+I.id+'&'+escape(c)+'&'+new Date().getTime();getXML(c,fn,function(v,e){try{v='|sXML|'+(v?v.readyState:e);fn(v);}catch(e){alert(e.message)}})}catch(e){alert(e.message)}};I.TimeOut=-1;I.EstMsg='Cargando ...';I.SPP="|!|";I.SPL="|:|";I.SPS="|*|";I.Sta=0;I.AER=0;I.AES='';I.xFS='';I.GROUPS=new Array;I.xGRP=new Array;I.USERS=new Array;I.SRV='';I.Version='1.0';I.FullSynck=0;I._xEPc=0;I.UserName='';I.Live=1;I.first=1;I.isServer=false;I.AcuData='';I.Color='';I.Server='';I.AutoGestor=0;I.NCW=getXHttp();I.e503=0;I.WS;I.PRTC=location.href.toLowerCase().indexOf('https:')==0?'https':'http';/*Eventos*//* - Reactor*/I.oninitialize;I.onstart;I.onerror;I.onsig;/* - Loader*/I.onload;I.onprogress;I.onacept;/* - Search*/I.onsearching;I.onclose;I.onadd;I.onrem;I.ongroup;I.onlock;I.onunlock;/* - Client*/I.onsend;I.onjoin;I.onreturnsearching;I.onconect;I.ondisconect;I.onserver;I.onrecibe;I.onexec;I.oncode;I.onpause;I.onwait;I._vWT=0;/*Metodos*/I.CWcmd=function(c,g,fn,LCW){try{if(!g){g='wake';}c=(c.indexOf('X-RT.SC.php?')==0?c:(I.Server?I.Server:'')+'¬¬#CREF#¬¬PlugIns/rt.RTP.COM.CWORK/?C='+c+'&IDX='+I.idx+'&G={G}');c=c+(c.indexOf('?')>0?'&':'?')+'DT='+new Date().getTime();getXML(c,function(h){I.e503=0;if(fn){fn(h);}},function(v,e){try{e='|sXML|'+(v?v.readyState:e);if(v.status&&v.status==503){I.e503=I.e503+1;}else{I.e503=0;}if(I.e503>1){setTimeout(function(){fn(e);},6000);}else{fn(e);}}catch(e){alert(e.description||e)}},window,LCW,'_G_='+escape(g));}catch(e){alert(e.description||e)}};I._xSrvHst=function(SRV){if(!SRV){SRV='';}if(I.Server!=SRV&&SRV!=''){I.Server=SRV;I.AcuData='';I.pld=0;}if(I.Server){SRV=I.Server;if(SRV.substr(0,4).toLowerCase()!='http'){SRV='http://'+SRV;}SRV=SRV.replace(/\\/g,'/').replace(/\/\//g,'/').replace(':/','://');var LNSZ=SRV.length-1;if(SRV.substr(LNSZ)=='/'){SRV=SRV.substr(0,LNSZ);}I.Server=SRV;}};I.CreateServer=function(GRP,NOM,SRV){if(GRP){I.GRP=GRP;}else if(GRP==false){I.GRP='';}I._xSrvHst(SRV);I._xStrtng(function(){I.Sta=2;if(NOM){I.UserName=NOM;}if(!I.UserName){I.UserName='Anonimo '+I.idx;}I.CWcmd('CREATESERVER',escape(I.GRP)+'&'+I.pre+'&'+I.max+'&'+I.TimeOut+'&'+escape(I.UserName),function(d){var OK=propOK(d);if(OK){I.GRP=propData(d);I._sStart(1);if(I.onjoin){I.onjoin(OK,I.GRP);}}else{I.Live=1;I.Sta=1;I._sStart();if(I.onerror){I.onerror('','',-99,'Error del Server: '+propData(d),'Create Server');}}});});};I.Start=function(GRP,SRV,fn){I.Initialize();if(I._bPau>0){I._bPau=I._bPau-1;return true;}if(I.Sta<0){I.NCW=getXHttp();I.Sta=-I.Sta;if(I.onpause){I.onpause(0);}return true;}if(I.pld>=0||GRP!=null||SRV!=null||I.Sta==0){if(GRP){I.GRP=GRP;}else if(GRP==false){I.GRP='';}I._xSrvHst(SRV);/*Detiene Sesion Anterior*/if(I.GRP){if(I.pld==1||I.pld===true){I.pld=0;I.Sta=2;if(fn){fn();}if(I.onjoin){I.onjoin(true,I.GRP);}}else if(I.Sta!=2){/*AutoJoin*/I.Join(null,null,fn);}else{if(fn){fn();}}}else if(I.Sta==0){/*AutoFind*/I._xStrtng(function(){I.FindServers(function(){I._sStart(0,fn);});});}}else{if(fn){fn();}}I.pld=-1;};I._bSta=1;I._sStart=function(cs,fn){if(I._bSta){I._bSta=0;if(I.onstart){I.onstart(I.idx,cs||false);}}if(fn){fn();}};I._xStrtng=function(f){if(I.idx){if(I.first){I.Initialize();}if(I.onsearching){I.onsearching(I.idx);}I.Live=1;I.Sta=1;if(f){f();}}else{I.Initialize(function(){I._xStrtng(f);});}};I._bPau=0;I.Pause=function(a){if(I.Sta>0){I.Sta=-I.Sta;if(I.onpause){I.onpause(1);}}else if(a){I._bPau=I._bPau+1;}};I.Status=function(GRP){I.EstMsg='Cargando ...';I.Sta=2;};I.Join=function(GRP,NOM,fn){if(GRP){I.GRP=GRP;}if(I.GRP){/*CLEAM*/if(I.Sta==2){for(ky in I.USERS){I.Death(ky,1);}}/*JOINED*/if(NOM){I.UserName=NOM;}if(!I.UserName){I.UserName='Anonimo '+I.idx;}I.CWcmd('JOIN',escape(I.GRP)+'&'+escape(I.pre)+'&'+I.max+'&'+I.TimeOut+'&'+escape(I.UserName),function(d){if(d.indexOf('|sXML|')==0){if(fn){fn();}return 0;}var OK=propOK(d);if(OK){I.GRP=propData(d);I.Live=1;I.Sta=2;}if(I.onjoin){I.onjoin(OK,I.GRP);}I._sStart(0,fn);});}};I.Close=function(idx,msg,SwError){/*Cierra conexion*/if(!idx){idx=I.idx;}I.CWcmd('CLOSE',escape(idx)+'&'+escape(msg),function(d){if(propOK(d)){d=propData(d);I.Death(d);if(d==I.idx){I.Sta=1;}}else if(propClass(d)!='sXML'&&(SwError==null||SwError==1)){alert('No se Puede Cerrar\n'+propData(d));}});};I.Sending=function(d){if(I.onsend){I.onsend(propOK(d),propData(d));}};I.Call=function(fn,ua,p1,p2,p3,p4,p5,p6,p7,p8,p9,pa,pb,pc,pd,pe,pf,pg,ignt){if(ua==null){ua='';}try{if(!isStr(ua)){ua=ua.join(';');}}catch(e){ua='';}I.CWcmd('CALL',escape(fn)+'&'+escape(ua)+'&'+escape(p1)+'&'+escape(p2)+'&'+escape(p3)+'&'+escape(p4)+'&'+escape(p5)+'&'+escape(p6)+'&'+escape(p7)+'&'+escape(p8)+'&'+escape(p9)+'&'+escape(pa)+'&'+escape(pb)+'&'+escape(pc)+'&'+escape(pd)+'&'+escape(pe)+'&'+escape(pf)+'&'+escape(pg),ignt?null:I.Sending);};I.XCall=function(fn,ua,p1,p2,p3,p4,p5,p6,p7,p8,p9,pa,pb,pc,pd,pe,pf,pg){I.Call(fn,ua,p1,p2,p3,p4,p5,p6,p7,p8,p9,pa,pb,pc,pd,pe,pf,pg,1);};I.Send=function(m,t,ua,ignt){if(ua==null){ua='';}try{if(!isStr(ua)){ua=ua.join(';');}}catch(e){ua='';}I.CWcmd('SEND',escape(m)+'&'+escape(t)+'&'+ua,ignt?null:I.Sending);};I.XSend=function(m,t,ua){I.Send(m,t,ua,1);};I.Client=function(GUID){return I.USERS[GUID];};I.Death=function(id,igm){if(id==I.idx&&!igm&&I.USERS[id]){/*Full Clients*/for(_xid in I.USERS){I.Death(_xid,1);}if(I.onreturnsearching){I.onreturnsearching(I.idx);}}else{/*1 Client*/var OJ=I.USERS[id];if(OJ){I.USERS[id]=0;try{RemoveOB(OJ);}catch(e){}}if(I.ondisconect&&(!I.AutoGestor||I.Sta==0)){I.ondisconect(id,OJ,I._vWT);}}};I._xTime=function(){/*Mantiene Activa la Conexión*/I.CWcmd('RESQUET','',I._xPrcDat,I.NCW);};I._xPrcErs=function(){I._vWT=0;I.Live=0;I.Sta=0;I.Death(I.idx);return false;};I._xPrcDat=function(d,eCod){try{if(I.Sta<0){if(d&&eCod==null){I.AcuData=I.AcuData+d;}I._xCrom();return false;}if(I.AcuData){d=I.AcuData+d;I.AcuData='';}if(d){var PM,id;d=d.split(I.SPL);for(i=0;i<d.length;i++){if(d[i]){PM=d[i].split(I.SPP);id=PM[1];if(I._vWT>0&&PM[0].indexOf('|sXML|')<0){I._vWT=0;if(I.onwait){I.onwait(I._vWT);}}if(PM[0]=='MTD'){/*Metodo*/eval(unescape(PM[1]));if(I.onexec){I.onexec(id,unescape(PM[1]));}}else if(PM[0]=='MSG'){if(I.onrecibe){I.onrecibe(id,unescape(PM[2]),unescape(PM[3]),I.USERS[id]);}}else if(PM[0]=='LNK'){/*Usuarios Vinculados*/var p,s,o,idt;for(p in I.USERS){s=I.USERS[p];if(s){s._x_CW_aC=0;}}for(p=2;p<PM.length;p++){s=PM[p].split(I.SPS);idt=s[0];/*MyUsu*/if(idt==I.idx){I.Color=s[1];}/*NewUsu*/o=I.USERS[idt];if(!o){if(I.onconect){o=I.onconect(idt,s[1],s[2]);}if(!o){o=new Object();}}o._x_CW_aC=1;I.USERS[idt]=o;}for(p in I.USERS){s=I.USERS[p];if(s&&!s._x_CW_aC){/*DeathUsu*/I.Death(p);}}/*NotyServer*/if(I.SRV!=id){I.SRV=id;I.isServer=id==I.idx;if(I.onserver){I.onserver(id==I.idx,id,I.USERS[id]);}}}else if(PM[0]=='SRV'){if(I.SRV!=id){I.SRV=id;I.isServer=id==I.idx;if(I.onserver){I.onserver(id==I.idx,id,I.USERS[id]);}}}else if(PM[0]=='ERASE'){return I._xPrcErs();}else if(PM[0]=='XAC'){if(PM[2]=='1'){I.AER=0;}if(I.onacept){I.onacept(PM[1],PM[2]);}}else if(PM[0]=='XPR'){if(PM[4]){I.EstMsg=PM[4];}if(I.onprogress){I.onprogress(PM[1],PM[2],PM[3],I.EstMsg);}}else if(PM[0]=='XER'){if(I.AES!=d[i]&&I.AER<parseInt(PM[3])){I.AER++;I.AES=d[i];if(I.onerror){I.onerror(PM[1],PM[2],PM[3],PM[4],PM[5]);}}}else if(PM[0]=='XLD'){I.AES='';if(I.onload){I.onload(PM[1],PM[2]=='TRUE');}}else if(PM[0]=='SIG'){if(I.onsig){I.onsig(PM[1],1);}}else if(PM[0]=='COD'){if(I.oncode&&I.Version==unescape(PM[3])){I.oncode(id,unescape(PM[2]));}}else if(PM[0]=='GRP'){/*LstGrp*/var s,t;for(id in I.xGRP){if(I.xGRP[id]!=null){I.xGRP[id]=9;}}/*Confirm*/for(var j=1;j<PM.length;j++){s=PM[j].split(I.SPS);id=s[0];t=I.xGRP[id];if(t==null){/*GADD*/I.xGRP[id]=s;if(!I.GROUPS[id]){if(I.onadd){I.GROUPS[id]=I.onadd(id,s[1],s[2],s[3]=='true');}if(!I.GROUPS[id]){I.GROUPS[id]=true;}}}else if(!IsEqualArrays(t,s)){/*GCHG*/I.xGRP[id]=s;if(I.ongroup){I.ongroup(id,s[1],s[2],s[3]=='true',I.GROUPS[id]);}}}/*GDEL*/for(id in I.xGRP){if(I.xGRP[id]===9){console.log('REM:'+id);var OJ=I.GROUPS[id];if(OJ){I.GROUPS[id]=null;try{RemoveOB(OJ);}catch(e){}if(I.onrem){I.onrem(id,OJ);}}I.xGRP[id]=null;}}}else if(PM[0].indexOf('|sXML|')==0){/* ServerBroken       --            Falta sincronizar la recuperacion del ultimo Paquete Perdido sXML en rt-lib-red           Falta sincronizar la Notificacion Rapida del servidor           --      */if(I.AutoGestor){if(I._vWT<=0){I._vWT=1;I.pld=0;}}else{I.Death(I.idx,null);}}}}}}catch(e){if(I.onerror){I.onerror(PM[1],PM[2],-99,e.description||e,PM[0]);}}I._xCrom();I._xEPc=0;return true;};I.FindServers=function(){I.CWcmd('FIND',I.pre+'&'+I.xFS,function(d){try{I.xFS=d;if(d){if(d.indexOf('|sXML|')!=0){}var PM;d=d.split(I.SPL);for(i=0;i<d.length;i++){if(d[i]){PM=d[i].split(I.SPP);var id=PM[1];}}}}catch(e){if(I.onerror){I.onerror('','',101,e.description||e,PM[0]);}}});};I._xPrcRCn=function(fn){if(I._vWT>0){try{if(I.onwait){I.onwait(I._vWT);}}catch(e){}if(I._vWT>1){I.Start(null,null,fn);}I._vWT=I._vWT+1;}};I.Background=function(t,id){return 'X-RT.SC.php?APP&'+I.CLS+'&¬¬#XID#¬¬&BACKGROUND&'+(id||I.idx)+' '+t+'&'+new Date().getTime();};I.SendCode=function(c,ua,id){I.CWcmd('X-RT.SC.php?APP&'+I.CLS+'&¬¬#XID#¬¬&SENDCODE&"'+escape(c).replace(/\%/g,'|')+'" "'+escape(ua||'')+'" "'+I.Version+'" '+(id||I.idx),'',I.Sending);};I.xCrSk=0;I._xCrom=function(t){if(I.xCrSk){clearTimeout(I.xCrSk);}I.xCrSk=setTimeout(I._xTime,(t>0?t:(I._vWT>0?500:1)))};I.Initialize=function(fn){if(!I.first){return true;}I.first=0;if(I.idx){I._xTime();if(I.oninitialize){I.oninitialize(1,I.idx);}}else{I.CWcmd('INIT','',function(d){d=d.split('¬');if(d[0]=='ONINIT'){I.idx=d[1];I._xTime();if(I.oninitialize){I.oninitialize(1,I.idx);}if(fn){fn();}}else{if(I.oninitialize){I.oninitialize(0,'');}if(I.onerror){I.onerror('','',-99,'Error del Server: '+d[0]+' : '+d[1],'Create Client');}}});}};/*Constructor*/if(!I.pre){I.pre='PUBLICO';}if(!I.idx){I.idx='';}if(!I.GRP){I.GRP=''}if(!I.max){I.max=99;}if(!I.URI){if(location.href.toLowerCase().indexOf('http')==0){I.URI=location.href.split('//')[1].split('/')[0];}else{I.URI='localhost';}}/*if(window.WebSocket){I.WS=new WebSocket((I.PRTC=='https'?'wss':'ws')+'://'+I.URI+'/'+I.idx+'?PRE='+escape(I.pre)+'&GROUP='+escape(I.GRP)+'&MAXUSERS='+escape(I.max)+'&DT='+new Date().getTime(),'CWork');}*/AddEvent(window,'load',function(){I.Initialize();});}